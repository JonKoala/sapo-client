<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/elements/sapo-styles.html">
<link rel="import" href="./avaliacoes/sapo-avaliacoes-math.html">

<dom-module id="sapo-relatorios">

  <template>

    <style include="sapo-styles">

      :host {
        display: flex;
        flex-wrap: wrap;
      }

      paper-card.card-block {
        width: 100%;
        margin: 5px 100px;
        padding: 20px;
      }

      p {
        margin: 5px 100px 100px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th, td {
        padding: 2px 10px;
        border: none;
      }

      thead {
        background: var(--paper-indigo-900);
        color: white;
        font-weight: bold;
      }

      .pilar {
        background: var(--paper-blue-800);
        color: white;
        font-weight: bold;
      }

      .tipo {
        background: var(--paper-blue-600);
        color: white;
        font-weight: bold;
      }

      .nivel {
        background: var(--paper-blue-200);
        font-weight: bold;
      }

      .subnivel {
        background: var(--paper-blue-grey-100);
      }

      .item {
        background: var(--paper-blue-50);
        border-bottom-style: solid;
        border-bottom-width: thin;
        border-bottom-color: var(--paper-blue-500);
      }

      .situacao {
        background: var(--paper-grey-50);
        border-bottom-style: solid;
        border-bottom-width: thin;
      }

      .nota {
        text-align: center;
      }

      .warning {
        background: var(--paper-red-100);
        color: var(--paper-red-900);
        border-bottom-style: solid;
        border-bottom-width: thin;
        font-weight: bold;
      }

      #information-area {
        margin: 5px 100px;
        width: 100%;
        display: flex;
        flex-direction: row;
      }

      #information-area div {
        margin: 10px 40px 10px 10px;
      }

      #information-area div b {
        white-space: pre;
      }

    </style>

    <app-route route="{{route}}" pattern="/:id" data="{{routeData}}"></app-route>

    <sapo-avaliacoes-math id="avaliacaoMath" ></sapo-avaliacoes-math>

    <iron-ajax auto="[[ready]]" url="[[appconfig.url.api]]/objetosavaliacao/[[id]]/full" last-response="{{objetoAvaliacao}}"></iron-ajax>
    <iron-ajax auto="[[ready]]" url="[[appconfig.url.api]]/notas/objetoavaliacao/[[id]]/full" loading="{{loading}}" last-response="{{notas}}"></iron-ajax>

    <paper-card id="information-area">
      <div class$="[[_computeTableCss(loading)]]"><b>ENTIDADE:</b> [[objetoAvaliacao.entidade.nome]] <b>   AVALIAÇÃO:</b> [[objetoAvaliacao.avaliacao.nome]]</div>
      <div class$="[[_computeTableCss(loading)]]"><b>Nota:</b> [[evaluationAbsoluteScore]] <b>   Pontuação Parcial:</b> [[evaluationRelativeScore]]</div>
      <div class$="[[_computeTableCss(loading)]]"><b>Concluído:</b> [[evaluationConclusionPercentage]]</div>
    </paper-card>

    <paper-card class="card-block">

      <paper-spinner active="[[loading]]" class$="[[_computeSpinnerCss(loading)]]" ></paper-spinner>

      <table class$="[[_computeTableCss(loading)]]">
        <thead>
          <th>Pilar</th>
          <th>Tipo</th>
          <th>Nível</th>
          <th>Subnível</th>
          <th>Item</th>
          <th>Situação Encontrada</th>
          <th>% de Atendimento</th>
        </thead>
        <tbody>
          <template is="dom-repeat" items="[[pilares]]" as="pilar">
            <tr>
              <td class="pilar" colspan="6">[[pilar.text]]</td>
              <td class="pilar nota">[[_computeAtendimento(pilar.score, pilar.maxScore, pilar.pending)]]</td>
            </tr>
            <template is="dom-repeat" items="[[pilar.tipos]]" as="tipo">
              <tr>
                <td></td>
                <td class="tipo" colspan="5">[[tipo.text]]</td>
                <td class$="tipo nota [[_computeItemScoreCss(tipo.score)]]">[[_computeAtendimento(tipo.score, tipo.maxScore, tipo.pending)]]</td>
              </tr>
              <template is="dom-repeat" items="[[tipo.niveis]]" as="nivel">
                <tr>
                  <td colspan="2"></td>
                  <td class="nivel" colspan="4">[[nivel.text]]</td>
                  <td class$="nivel nota [[_computeItemScoreCss(nivel.score)]]">[[_computeAtendimento(nivel.score, nivel.maxScore, nivel.pending)]]</td>
                </tr>
                <template is="dom-repeat" items="[[nivel.subniveis]]" as="subnivel">
                  <tr>
                    <td colspan="3"></td>
                    <td class="subnivel" colspan="3">[[subnivel.text]]</td>
                    <td class$="subnivel nota [[_computeItemScoreCss(subnivel.score)]]">[[_computeAtendimento(subnivel.score, subnivel.maxScore, subnivel.pending)]]</td>
                  </tr>
                  <template is="dom-repeat" items="[[subnivel.itens]]">
                    <tr>
                      <td colspan="4"></td>
                      <td class="item">[[item.text]]</td>
                      <td class="situacao">[[item.atendimento.text]]</td>
                      <td class$="situacao nota [[_computeItemScoreCss(item.atendimento.score)]]">[[item.atendimento.nota]]</td>
                    </tr>
                  </template>
                </template>
              </template>
            </template>
          </template>
        </tbody>
      </table>
    </paper-card>
    <p class$="[[_computeTableCss(loading)]]">* Nota inclui itens ainda não avaliados.</p>

  </template>

  <script>
    class SapoRelatorios extends Polymer.Element {

      static get is() { return 'sapo-relatorios'; }

      static get properties() {
        return {
          id: {
            type: Number,
            computed: '_computeId(routeData)'
          },
          pilares: {
            type: Array,
            computed: '_computePilares(notas)'
          },

          notas: {
            type: Array,
            observer: '_notasChanged'
          },
          objetoAvaliacao: Object,

          evaluationConclusionPercentage: String,
          evaluationAbsoluteScore: String,
          evaluationRelativeScore: String,

          ready: {
            type: Boolean,
            computed: '_isReady(route, appconfig)'
          },
          loading: Boolean
        }
      }


      //
      //COMPUTEDS

      _computeSpinnerCss(isLoading) {
        return (isLoading) ? '' : 'hidden';
      }

      _computeTableCss(isLoading) {
        return (isLoading) ? 'hidden' : '';
      }

      _isReady(route, appconfig) {
        return route != null && appconfig != null;
      }

      _computeId(routeData) {
        return parseInt(routeData.id);
      }

      _computeItemScoreCss(score) {
        if (!score) return 'warning';
      }

      _computeAtendimento(score, maxScore, isPending) {
        var percentage = this.$.avaliacaoMath.makePrintableScore(score, maxScore, 2);
        percentage = (isPending) ? percentage + '%*' : percentage + '%';

        return percentage;
      }

      _computePilares(notas) {

        var pilares = [];
        notas.forEach(nota => {

          let notaPilar = nota.item.subnivel.nivel.tipo.pilar;
          let pilar = pilares.find(pilar => { return pilar.id == notaPilar.id; });
          if (pilar == null) {
            pilar = {id: notaPilar.id, text: notaPilar.nome, tipos: [], maxScore: 0, score: 0, pending: false};
            pilares.push(pilar);
          }

          let notaTipo = nota.item.subnivel.nivel.tipo;
          let tipo = pilar.tipos.find(tipo => { return tipo.id == notaTipo.id; });
          if (tipo == null) {
            tipo = {id: notaTipo.id, text: notaTipo.nome, niveis: [], maxScore: 0, score: 0, pending: false};
            pilar.tipos.push(tipo);
          }

          let notaNivel = nota.item.subnivel.nivel;
          let nivel = tipo.niveis.find(nivel => { return nivel.id == notaNivel.id; });
          if (nivel == null) {
            nivel = {id: notaNivel.id, text: notaNivel.nome, subniveis: [], maxScore: 0, score: 0, pending: false};
            tipo.niveis.push(nivel);
          }

          let notaSubnivel = nota.item.subnivel;
          let subnivel = nivel.subniveis.find(subnivel => { return subnivel.id == notaSubnivel.id; });
          if (subnivel == null) {
            subnivel = {id: notaSubnivel.id, text: notaSubnivel.nome, itens: [], maxScore: 0, score: 0, pending: false};
            nivel.subniveis.push(subnivel);
          }

          let item = nota.item;
          item.nota = nota;
          item.text = nota.item.nome;
          item.pontuacao = nota.item.pontuacoes.find(pontuacao => pontuacao.id === nota.pontuacao_id);
          item.atendimento = (item.pontuacao) ? {text: item.pontuacao.descricao, score: item.pontuacao.nota, nota: (item.pontuacao.nota * 100)+'%'} : {text: '', score: 0,nota: 'não avaliado'};

          var maxScore = nota.item.notaMaxima;
          pilar.maxScore += maxScore;
          tipo.maxScore += maxScore;
          nivel.maxScore += maxScore;
          subnivel.maxScore += maxScore;

          var score = item.atendimento.score * nota.item.notaMaxima;
          pilar.score += score;
          tipo.score += score;
          nivel.score += score;
          subnivel.score += score;

          var isPending = !item.pontuacao;
          pilar.pending |= isPending;
          tipo.pending |= isPending;
          nivel.pending |= isPending;
          subnivel.pending |= isPending;

          subnivel.itens.push(item);
        });

        return pilares;
      }


      //
      //OBSERVERS

      _notasChanged(notas) {

        //give each nota its pontuacao object, acording with its pontuacao_id
        notas.forEach(nota => {
          nota.pontuacao = nota.item.pontuacoes.find(pontuacao => pontuacao.id === nota.pontuacao_id);
        });

        this._updateEvaluationResults();
      }


      //
      //UTILS

      _updateEvaluationResults() {

        if (this.notas.length === 0) return;

        var conclusionPercentage = this.$.avaliacaoMath.calcPercentageOfConclusion(this.notas);
        this.evaluationConclusionPercentage = conclusionPercentage + '%';

        var absoluteScore = this.$.avaliacaoMath.calcAbsoluteScore(this.notas);
        this.evaluationAbsoluteScore = absoluteScore.absoluteScore + ' de ' + absoluteScore.maxScore + '\n(' + absoluteScore.percentage + '%)';

        var relativeScore = this.$.avaliacaoMath.calcRelativeScore(this.notas);
        this.evaluationRelativeScore = relativeScore.relativeScore + ' de ' + relativeScore.maxScore + '\n(' + relativeScore.percentage + '%)';
      }

    }

    window.customElements.define(SapoRelatorios.is, SapoRelatorios);
  </script>
</dom-module>
