<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="/elements/sapo-overlay.html">
<link rel="import" href="./sapo-avaliacoes-styles.html">
<link rel="import" href="./sapo-avaliacoes-math.html">
<link rel="import" href="./sapo-menu-indicadores.html">
<link rel="import" href="./sapo-list-notas.html">
<link rel="import" href="./sapo-crud-nota.html">

<dom-module id="sapo-evaluate-objeto-avaliacao">

  <template>

    <style include="sapo-avaliacoes-styles">

      :host {
        display: flex;
        flex-wrap: wrap;
      }

      sapo-overlay {
        margin: 80px;
        min-width: 500px;
      }

      #information-area {
        width: 100%;
        display: flex;
        flex-direction: row;
      }

      #information-area div {
        margin: 10px 40px 10px 10px;
      }

      #information-area div b {
        white-space: pre;
      }

      #evaluation-area {
        display: flex;
        width: 100%;
      }

      #menu-indicadores-area {
        margin-right: 20px;
        height: 290px;
      }

      #list-notas-area {
        margin-left: 20px;
        width: 100%;
      }

    </style>

    <sapo-avaliacoes-math id="avaliacaoMath" ></sapo-avaliacoes-math>

    <iron-ajax auto="[[active]]" url="[[appconfig.url.api]]/objetosavaliacao/[[objetoAvaliacaoId]]/full" last-response="{{objetoAvaliacao}}"></iron-ajax>
    <iron-ajax auto="[[active]]" url="[[appconfig.url.api]]/notas/objetoavaliacao/[[objetoAvaliacaoId]]/full" loading="{{loading}}" last-response="{{notas}}"></iron-ajax>
    <iron-ajax auto="[[active]]" url="[[appconfig.url.api]]/navegadores/" last-response="{{navegadores}}"></iron-ajax>
    <iron-ajax id="putAjax" url="[[appconfig.url.api]]/notas/pontuacao" method="PUT" content-type="application/json" handle-as="json" on-response="_quickNotaSaved"></iron-ajax>

    <paper-card id="information-area" class="card-block">
      <div class$="[[_computeListNotasCss(loading)]]"><b>ENTIDADE:</b> [[objetoAvaliacao.entidade.nome]] <b>   AVALIAÇÃO:</b> [[objetoAvaliacao.avaliacao.nome]]</div>
      <div class$="[[_computeListNotasCss(loading)]]"><b>Nota:</b> [[evaluationAbsoluteScore]] <b>   Pontuação Parcial:</b> [[evaluationRelativeScore]]</div>
      <div class$="[[_computeListNotasCss(loading)]]"><b>Concluído:</b> [[evaluationConclusionPercentage]]</div>
    </paper-card>

    <div id="evaluation-area" >
      <paper-card id="menu-indicadores-area" class="card-block">
        <sapo-menu-indicadores id="menuIndicadores" data="[[indicadores]]" pilar="{{pilar}}" tipo="{{tipo}}" nivel="{{nivel}}" subnivel="{{subnivel}}"></sapo-menu-indicadores>
      </paper-card>

      <paper-card id="list-notas-area" class="card-block">
        <paper-spinner active="[[loading]]" class$="[[_computeSpinnerCss(loading)]]" ></paper-spinner>
        <sapo-list-notas on-nota-changed="_updateNota" on-edit-clicked="_editNota" data="[[notas]]" ids-to-show="[[_computeNotasToShow(notas, pilar, tipo, nivel, subnivel)]]" class$="[[_computeListNotasCss(loading)]]" ></sapo-list-notas>
      </paper-card>
    </div>

    <sapo-overlay id="overlayArea" on-close="_crudClosed" with-backdrop>
      <sapo-crud-nota id="crudNota" navegadores="[[navegadores]]" appconfig="[[appconfig]]" on-save="_notaSaved" ></sapo-crud-nota>
    </sapo-overlay>

    <paper-toast id="quickNote"></paper-toast>

  </template>

  <script>
    class SapoEvaluateObjetoAvaliacao extends Polymer.Element {

      static get is() { return 'sapo-evaluate-objeto-avaliacao'; }

      static get properties() {
        return {
          active: {
            type: Boolean,
            value: false,
            observer: '_activeChanged'
          },
          loading: Boolean,

          objetoAvaliacaoId: Number,
          objetoAvaliacao: Object,
          notas: {
            type: Array,
            observer: '_notasChanged'
          },
          navegadores: Array,

          evaluationConclusionPercentage: String,
          evaluationAbsoluteScore: String,
          evaluationRelativeScore: String,

          indicadores: {
            type: Object,
            value: () => { return {pilares: [], tipos: [], niveis: [], subniveis: []}; }
          },
          pilar: Number,
          tipo: Number,
          nivel: Number,
          subnivel: Number
        }
      }


      //
      //OBSERVERS & COMPUTEDS

      _computeNotasToShow(notas, pilar, tipo, nivel, subnivel) {

        if (!notas) return []; //no notas to show yet
        if (!pilar) return notas.map(nota => { return nota.id; }); //first filter is special

        var notasToShow =  notas.filter(nota => {
          let result = true;
          if (pilar) result = (nota.item.subnivel.nivel.tipo.pilar.id === pilar);
          if (tipo) result = (nota.item.subnivel.nivel.tipo.id === tipo);
          if (nivel) result = (nota.item.subnivel.nivel.id === nivel);
          if (subnivel) result = (nota.item.subnivel.id === subnivel);
          return result;
        });

        return notasToShow.map(nota => { return nota.id; });
      }

      _computeSpinnerCss(isLoading) {
        return (isLoading) ? '' : 'hidden';
      }

      _computeListNotasCss(isLoading) {
        return (isLoading) ? 'hidden' : '';
      }

      _notasChanged(notas) {

        //give each nota its pontuacao object, acording with its pontuacao_id
        notas.forEach(nota => {
          nota.pontuacao = nota.item.pontuacoes.find(pontuacao => pontuacao.id === nota.pontuacao_id);
        });

        //create indicadores objects
        var indicadores = this._getIndicadoresFromNotas(notas);
        this._updateIndicadores(indicadores, notas);

        this._updateEvaluationResults();
      }

      _activeChanged(isActive) {
        if (!isActive)
          this.notas = [];
      }


      //
      //EVENTS

      _updateNota(e) {
        this.$.putAjax.body = e.detail;
        this.$.putAjax.generateRequest();
      }

      _editNota(e) {
        this.$.crudNota.id = e.detail.id;
        this.$.crudNota.active = true;

        this.$.overlayArea.open();
      }

      _notaSaved(e) {
        this.$.overlayArea.close();
        this._notifyPontuacao(e.detail.success);
      }

      _quickNotaSaved(e) {
        this._notifyPontuacao(e.detail.status === 200);

        var response = e.detail.response;
        this._updateNotas(response.nota, response.pontuacao);
        this._updateIndicadores(this.indicadores, this.notas);
        this._updateEvaluationResults();
      }

      _crudClosed() {
        this.$.crudNota.active = false;
      }


      //
      //UTILS

      _updateNotas(nota, pontuacao) {
        var notaObj = this.notas.find(n => n.id === nota);
        notaObj.pontuacao_id = pontuacao;
        notaObj.pontuacao = notaObj.item.pontuacoes.find(p => p.id === pontuacao);
      }

      _updateIndicadores(indicadores, notas) {

        var unevaluated = notas.filter(nota => { return nota.pontuacao == null; });
        var unevaluatedIndicadores = this._getIndicadoresFromNotas(unevaluated);

        var markIndicador = (indicador, warningList) => {
          indicador.warning = warningList.some(i => i.id === indicador.id);
        }

        //add update/add warning variable to unevaluated indicadores
        indicadores.pilares.forEach(pilar => markIndicador(pilar, unevaluatedIndicadores.pilares));
        indicadores.tipos.forEach(tipo => markIndicador(tipo, unevaluatedIndicadores.tipos));
        indicadores.niveis.forEach(nivel => markIndicador(nivel, unevaluatedIndicadores.niveis));
        indicadores.subniveis.forEach(subnivel => markIndicador(subnivel, unevaluatedIndicadores.subniveis));

        this.indicadores = indicadores;
        this.$.menuIndicadores.softUpdate(indicadores);
      }

      _updateEvaluationResults() {

        if (this.notas.length === 0) return;

        var conclusionPercentage = this.$.avaliacaoMath.calcPercentageOfConclusion(this.notas);
        this.evaluationConclusionPercentage = conclusionPercentage + '%';

        var absoluteScore = this.$.avaliacaoMath.calcAbsoluteScore(this.notas);
        this.evaluationAbsoluteScore = absoluteScore.absoluteScore + ' de ' + absoluteScore.maxScore + '\n(' + absoluteScore.percentage + '%)';

        var relativeScore = this.$.avaliacaoMath.calcRelativeScore(this.notas);
        this.evaluationRelativeScore = relativeScore.relativeScore + ' de ' + relativeScore.maxScore + '\n(' + relativeScore.percentage + '%)';
      }

      _notifyPontuacao(success) {
        if (success) this._showNotification('Pontuação atualizada com sucesso!');
      }

      _showNotification(text) {

        var note = this.$.quickNote;

        //prepare and show note
        note.close();
        note.text = text;
        note.open();
      }

      _getIndicadoresFromNotas(notas) {

        var addIfUnique = (array, item) => {
          if (!array.some(i => { return i.id === item.id}))
            array.push(item);
        };

        var indicadores = {pilares: [], tipos: [], niveis: [], subniveis: []};
        notas.forEach(nota => {
          addIfUnique(indicadores.pilares, nota.item.subnivel.nivel.tipo.pilar);
          addIfUnique(indicadores.tipos, nota.item.subnivel.nivel.tipo);
          addIfUnique(indicadores.niveis, nota.item.subnivel.nivel);
          addIfUnique(indicadores.subniveis, nota.item.subnivel);
        });

        return indicadores;
      }

    }

    window.customElements.define(SapoEvaluateObjetoAvaliacao.is, SapoEvaluateObjetoAvaliacao);
  </script>
</dom-module>
