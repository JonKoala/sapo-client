
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../elements/sapo-selector-crud.html">
<link rel="import" href="../elements/sapo-overlay.html">
<link rel="import" href="./sapo-crud-indicador.html">

<dom-module id="sapo-indicadores">

  <template>

    <style include="iron-flex iron-flex-factors">
      paper-card {
        margin-left: 80px;
        margin-right: 80px;
      }
      sapo-overlay {
        margin: 80px;
        min-width: 500px;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/:indicador"
      data="{{routeData}}"
      tail="{{subroute}}">
    </app-route>

    <iron-ajax auto indicador="indicador" url="http://N350i-22878:8080/indicadores/" last-response="{{indicadores}}"></iron-ajax>
    <iron-ajax indicador="pilar" url="http://N350i-22878:8080/pilares/indicador/[[indicador]]" last-response="{{pilares}}"></iron-ajax>
    <iron-ajax indicador="tipo" url="http://N350i-22878:8080/tipos/pilar/[[pilar]]" last-response="{{tipos}}"></iron-ajax>
    <iron-ajax indicador="nivel" url="http://N350i-22878:8080/niveis/tipo/[[tipo]]" last-response="{{niveis}}"></iron-ajax>
    <iron-ajax indicador="subnivel" url="http://N350i-22878:8080/subniveis/nivel/[[nivel]]" last-response="{{subniveis}}"></iron-ajax>

    <paper-card class="layout vertical fit">

      <sapo-selector-crud indicador="indicador" label="Indicador" data="[[indicadores]]" selected="{{indicador}}" on-add="_newIndicador" ></sapo-selector-crud>
      <sapo-selector-crud indicador="pilar" label="Pilar" data="[[pilares]]" selected="{{pilar}}"></sapo-selector-crud>
      <sapo-selector-crud indicador="tipo" label="Tipo" data="[[tipos]]" selected="{{tipo}}"></sapo-selector-crud>
      <sapo-selector-crud indicador="nivel" label="Nivel" data="[[niveis]]" selected="{{nivel}}"></sapo-selector-crud>
      <sapo-selector-crud indicador="subnivel" label="SubnÃ­vel" data="[[subniveis]]" selected="{{subnivel}}"></sapo-selector-crud>

    </paper-card>

    <sapo-overlay id="overlayArea" with-backdrop>
      <iron-pages selected="[[crud]]" attr-for-selected="indicador">
        <sapo-crud-indicador indicador="indicador" on-save="_indicadorSaved"></sapo-crud-indicador>
      </iron-pages>
    </sapo-overlay>

  </template>

  <script>
    class SapoIndicadores extends Polymer.Element {

      static get is() { return 'sapo-indicadores'; }

      static get properties() {
        return {
          indicador: {
            type: Number,
            observer: '_indicadorChanged',
          },
          pilar: {
            type: Number,
            observer: '_pilarChanged',
          },
          tipo: {
            type: Number,
            observer: '_tipoChanged',
          },
          nivel: {
            type: Number,
            observer: '_nivelChanged',
          },
          subnivel: Number,

          indicadores: Array,
          pilares: Array,
          tipos: Array,
          niveis: Array,
          subniveis: Array,

          crud: String
        }
      }

      _indicadorChanged(newId) {
        this._changeNextIndicador(newId, 'pilar');
      }

      _pilarChanged(newId) {
        this._changeNextIndicador(newId, 'tipo');
      }

      _tipoChanged(newId) {
        this._changeNextIndicador(newId, 'nivel');
      }

      _nivelChanged(newId) {
        this._changeNextIndicador(newId, 'subnivel');
      }

      _newIndicador(e) {
        this.crud = e.target.getAttribute('indicador');
        this.$.overlayArea.open();
      }

      _indicadorSaved(e) {
        this.$.overlayArea.close();

        let indicador = e.target.getAttribute('indicador');
        let entity = e.detail;

        let ajax = Polymer.dom(this.root).querySelector('iron-ajax[indicador=' + indicador + ']')

        ajax.generateRequest().completes
          .then(() => {
            this[indicador] = entity.id;
          });
      }

      _changeNextIndicador(newId, nextIndicador) {
        let nextSelector = Polymer.dom(this.root).querySelector('sapo-selector-crud[indicador=' + nextIndicador + ']');
        let nextAjax = Polymer.dom(this.root).querySelector('iron-ajax[indicador=' + nextIndicador + ']');

        nextSelector.disabled = (newId === 0);
        nextAjax.generateRequest();
      }

    }

    window.customElements.define(SapoIndicadores.is, SapoIndicadores);
  </script>
</dom-module>
