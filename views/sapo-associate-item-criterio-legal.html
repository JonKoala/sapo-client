<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../elements/sapo-item-crud.html">

<dom-module id="sapo-associate-item-criterio-legal">

  <template>

    <style>
      :host {
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      .blue {
        background: #337ab7;
      }

      .gray {
        background: #616161;
      }

      .red {
        background: #d9534f;
      }

      paper-listbox {
        --paper-listbox-background-color: lightgray;

        --sapo-item-crud-default-background: var(--paper-blue-grey-100); /* because css var is still bugged... */

        height: 250px;
        padding: 0px;
        overflow: auto;
      }

      sapo-item-crud {
        outline: 0;
      }

      div {
        padding-top: 50px;
      }

      paper-button {
        color: white;
      }

      paper-button[disabled] {
        background: #eaeaea;
        color: #a8a8a8;
      }
    </style>

    <iron-ajax id="getAjax" url="http://N350i-22878:8080/criterioslegais/item/not/[[fk]]" last-response="{{data}}"></iron-ajax>
    <iron-ajax id="postjax"
      url="http://n350i-22878:8080/itenscriterioslegais/"
      method="POST"
      content-type="application/json"
      handle-as="json"
      body="[[_computedPostBody(selectedAux)]]"
      on-response="_postResponse">
    </iron-ajax>

    <paper-listbox selected-values="{{selected}}" selected-items="{{selectedAux}}" attr-for-selected="identity" multi>
      <template is="dom-repeat" items="[[data]]">
        <sapo-item-crud text="[[_computeText(item.descricao, item.norma.nome)]]" identity="[[item.id]]" undeletable uneditable></sapo-item-crud>
      </template>
    </paper-listbox>

    <div hidden="[[removeMode]]" >
      <paper-button disabled="[[saveDisabled]]" class="blue" on-click="_submitClicked" raised><iron-icon icon="save"></iron-icon>Salvar</paper-button>
      <paper-button class="gray" on-click="_clearClicked" raised><iron-icon icon="rounded-corner"></iron-icon>Limpar</paper-button>
    </div>

  </template>

  <script>
    class sapoAssociateItemCriterioLegal extends Polymer.Element {

      static get is() { return 'sapo-associate-item-criterio-legal'; }

      static get properties() {
        return {
          fk: Number,
          data: Array,
          selected: Array,
          selectedAux: Array, /* can't use paper-listbox's selected-values on a computed property */

          mode: {
            type: String,
            observer: '_modeChanged'
          },

          saveDisabled: {
            type: Boolean,
            computed: '_isSaveDisabled(selectedAux)'
          },
          removeMode: {
            type: Boolean,
            computed: '_isRemoveMode(mode)'
          },
        }
      }


      //
      //OBSERVERS & COMPUTEDS

      _modeChanged(newMode) {

        switch (newMode) {
          case 'add':
            this.$.getAjax.generateRequest();
            break;
          case 'remove':
            break;
          case 'closed':
            this._clear();
            break;
        }
      }

      _isSaveDisabled(selected) {
        return this.selected.length < 1;
      }

      _isRemoveMode(mode) {
        return mode === 'remove';
      }

      _computeText(criterioLegal, norma) {
        return criterioLegal + " - " + norma;
      }

      _computedPostBody() {
        return this.selected.map(criterioLegal => {
          return {item_id: this.fk, criterio_legal_id: criterioLegal};
        });
      }


      //
      //EVENTS

      _submitClicked() {
        this.$.postjax.generateRequest();
      }

      _clearClicked() {
        this._clear();
      }

      _postResponse(e) {
        this.dispatchEvent(new CustomEvent('save', {detail: e.detail.response}));
      }


      //
      //UTILS

      _clear() {
        this.set('selected', []);
      }

    }

    window.customElements.define(sapoAssociateItemCriterioLegal.is, sapoAssociateItemCriterioLegal);
  </script>
</dom-module>
